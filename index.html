<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Juego Piano Spotify</title>
<style>
  :root {
    --bg-color: #222;
    --key-a-color: #e91e63;
    --key-s-color: #9c27b0;
    --key-d-color: #3f51b5;
    --key-f-color: #03a9f4;
    --key-g-color: #009688;
    --key-h-color: #4caf50;
    --key-j-color: #ff9800;
    --falling-a-color: #e91e63;
    --falling-s-color: #9c27b0;
    --falling-d-color: #3f51b5;
    --falling-f-color: #03a9f4;
    --falling-g-color: #009688;
    --falling-h-color: #4caf50;
    --falling-j-color: #ff9800;
  }
  
  body {
    font-family: Arial, sans-serif;
    background: var(--bg-color);
    color: #eee;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  #game-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 600px;
    flex-grow: 1;
    padding: 20px;
  }
  #game-screen {
    width: 100%;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  #score-display {
    font-size: 18px;
    margin-bottom: 10px;
    text-align: center;
  }
  #game-area {
    position: relative;
    background: #111;
    height: 600px;
    border: 2px solid #444;
    overflow: hidden;
    flex-grow: 1;
  }
  #piano-keys {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
  }
  .piano-key {
    width: 50px;
    height: 70px;
    background: var(--key-color);
    border-radius: 5px;
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    cursor: default;
    font-weight: bold;
    font-size: 18px;
    color: #eee;
    transition: all 0.2s;
    position: relative;
  }
  #piano-key-a { --key-color: var(--key-a-color); }
  #piano-key-s { --key-color: var(--key-s-color); }
  #piano-key-d { --key-color: var(--key-d-color); }
  #piano-key-f { --key-color: var(--key-f-color); }
  #piano-key-g { --key-color: var(--key-g-color); }
  #piano-key-h { --key-color: var(--key-h-color); }
  #piano-key-j { --key-color: var(--key-j-color); }
  
  .piano-key.active {
    transform: scale(0.95);
    box-shadow: 0 0 15px #fff;
  }
  
  .falling-key {
    position: absolute;
    top: -40px;
    width: 30px;
    height: 30px;
    border-radius: 5px;
    font-size: 18px;
    color: white;
    text-align: center;
    line-height: 30px;
    font-weight: bold;
    pointer-events: none;
    user-select: none;
    transition: all 0.1s;
    background-color: var(--falling-color);
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    left: 10px;
  }
  
  .falling-key::before {
    content: "▼";
    position: absolute;
    top: -15px;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 16px;
  }
  
  .falling-key.intense {
    width: 40px;
    height: 40px;
    font-size: 20px;
    line-height: 40px;
    box-shadow: 0 0 15px gold;
    z-index: 10;
    left: 5px;
  }
  
  #controls-container {
    width: 100%;
    margin-top: 10px;
    padding: 15px;
    background: #333;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #main-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 10px;
    width: 100%;
  }
  #spotify-controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
  }
  button {
    background-color: #555;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    color: #eee;
    cursor: pointer;
    min-width: 100px;
    transition: all 0.2s;
  }
  button:hover {
    transform: scale(1.05);
  }
  button:disabled {
    background-color: #333;
    cursor: not-allowed;
    transform: none;
  }
  #now-playing {
    margin: 20px 0;
    display: none;
    text-align: center;
  }
  #now-playing img {
    width: 120px;
    height: 120px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
  }
  #track-name {
    font-weight: bold;
    margin-top: 10px;
    font-size: 18px;
  }
  #track-artist {
    font-style: italic;
    color: #ccc;
    margin-bottom: 10px;
  }
  #auth-status {
    margin: 10px 0;
    height: 20px;
    text-align: center;
  }
  .success-message {
    color: #4caf50;
  }
  .error-message {
    color: #f44336;
  }
  #spotify-login {
    background-color: #1db954;
    border: none;
    padding: 10px 20px;
    color: white;
    border-radius: 30px;
    cursor: pointer;
    font-weight: bold;
    font-size: 16px;
    margin: 10px 0;
    transition: all 0.3s;
  }
  #spotify-login:hover {
    transform: scale(1.05);
    box-shadow: 0 0 10px rgba(29, 185, 84, 0.5);
  }
  #settings-panel {
    margin-top: 20px;
    padding: 15px;
    background: #333;
    border-radius: 10px;
    width: 100%;
  }
  .color-picker {
    display: flex;
    align-items: center;
    margin: 5px 0;
  }
  .color-picker label {
    width: 100px;
    display: inline-block;
  }
  input[type="color"] {
    width: 50px;
    height: 30px;
    border: none;
    cursor: pointer;
    background: transparent;
  }
  #save-settings {
    margin-top: 10px;
    background-color: #4caf50;
    font-weight: bold;
  }
  #save-settings:hover {
    background-color: #3e8e41;
  }
  #high-score {
    margin-top: 10px;
    font-size: 18px;
    text-align: center;
    color: gold;
    font-weight: bold;
  }
</style>
</head>
<body>

<div id="game-container">

  <div id="game-screen">
    <div id="score-display">
      Puntuación: <span id="score">0</span> | Aciertos: <span id="hits">0</span> | Fallos: <span id="misses">0</span>
    </div>

    <div id="game-area">
      <!-- Las teclas que caen aparecerán aquí -->
    </div>

    <div id="piano-keys">
      <div class="piano-key" data-key="a" id="piano-key-a">A</div>
      <div class="piano-key" data-key="s" id="piano-key-s">S</div>
      <div class="piano-key" data-key="d" id="piano-key-d">D</div>
      <div class="piano-key" data-key="f" id="piano-key-f">F</div>
      <div class="piano-key" data-key="g" id="piano-key-g">G</div>
      <div class="piano-key" data-key="h" id="piano-key-h">H</div>
      <div class="piano-key" data-key="j" id="piano-key-j">J</div>
    </div>

    <div id="high-score">
      Mejor Puntuación: <span id="high-score-value">0</span>
    </div>

    <div id="now-playing">
      <img id="track-image" src="" alt="Portada del álbum" />
      <div id="track-name"></div>
      <div id="track-artist"></div>
    </div>
  </div>

  <div id="controls-container">
    <div id="main-controls">
      <button id="start-btn">Iniciar Juego</button>
      <button id="pause-btn" disabled>Pausar</button>
      <button id="exit-btn" disabled>Salir</button>
    </div>

    <div id="spotify-controls">
      <button id="spotify-login">Conectar con Spotify</button>
      <div id="auth-status"></div>
    </div>
  </div>

  <div id="settings-panel">
    <h3>Personalización</h3>
    <div class="color-picker">
      <label>Fondo:</label>
      <input type="color" id="bg-color" value="#222222">
    </div>
    <h4>Colores de teclas:</h4>
    <div class="color-picker">
      <label>Tecla A:</label>
      <input type="color" id="key-a-color" value="#e91e63">
    </div>
    <div class="color-picker">
      <label>Tecla S:</label>
      <input type="color" id="key-s-color" value="#9c27b0">
    </div>
    <div class="color-picker">
      <label>Tecla D:</label>
      <input type="color" id="key-d-color" value="#3f51b5">
    </div>
    <div class="color-picker">
      <label>Tecla F:</label>
      <input type="color" id="key-f-color" value="#03a9f4">
    </div>
    <div class="color-picker">
      <label>Tecla G:</label>
      <input type="color" id="key-g-color" value="#009688">
    </div>
    <div class="color-picker">
      <label>Tecla H:</label>
      <input type="color" id="key-h-color" value="#4caf50">
    </div>
    <div class="color-picker">
      <label>Tecla J:</label>
      <input type="color" id="key-j-color" value="#ff9800">
    </div>
    <h4>Colores de flechas:</h4>
    <div class="color-picker">
      <label>Flecha A:</label>
      <input type="color" id="falling-a-color" value="#e91e63">
    </div>
    <div class="color-picker">
      <label>Flecha S:</label>
      <input type="color" id="falling-s-color" value="#9c27b0">
    </div>
    <div class="color-picker">
      <label>Flecha D:</label>
      <input type="color" id="falling-d-color" value="#3f51b5">
    </div>
    <div class="color-picker">
      <label>Flecha F:</label>
      <input type="color" id="falling-f-color" value="#03a9f4">
    </div>
    <div class="color-picker">
      <label>Flecha G:</label>
      <input type="color" id="falling-g-color" value="#009688">
    </div>
    <div class="color-picker">
      <label>Flecha H:</label>
      <input type="color" id="falling-h-color" value="#4caf50">
    </div>
    <div class="color-picker">
      <label>Flecha J:</label>
      <input type="color" id="falling-j-color" value="#ff9800">
    </div>
    <button id="save-settings">Guardar Configuración</button>
  </div>
</div>

<script>
  // Configuración de Spotify
  const clientId = '4f7eb3551b204789abd64461c8908c1e';
  const redirectUri = window.location.origin + window.location.pathname;

  // Elementos del DOM
  const startBtn = document.getElementById('start-btn');
  const pauseBtn = document.getElementById('pause-btn');
  const exitBtn = document.getElementById('exit-btn');
  const spotifyLogin = document.getElementById('spotify-login');
  const authStatus = document.getElementById('auth-status');
  const nowPlaying = document.getElementById('now-playing');
  const trackImage = document.getElementById('track-image');
  const trackName = document.getElementById('track-name');
  const trackArtist = document.getElementById('track-artist');
  const scoreDisplay = document.getElementById('score');
  const hitsDisplay = document.getElementById('hits');
  const missesDisplay = document.getElementById('misses');
  const gameArea = document.getElementById('game-area');
  const saveSettingsBtn = document.getElementById('save-settings');
  const highScoreDisplay = document.getElementById('high-score-value');

  // Configuración de teclas
  const keys = ['a', 's', 'd', 'f', 'g', 'h', 'j'];
  let keyColors = {};
  let fallingKeyColors = {};
  let player;
  let deviceId;

  // Estado del juego
  let score = 0;
  let hits = 0;
  let misses = 0;
  let highScore = 0;
  let gameActive = false;
  let gamePaused = false;
  let fallingKeys = [];
  let animationId;
  let accessToken = null;
  let refreshToken = null;
  let trackAnalysis = null;
  let currentTrack = null;
  let lastBeatTime = 0;
  let checkPlayerInterval;
  let nextBeatIndex = 0;
  let trackList = [];
  let beatInterval;
  let lastIntenseBeatTime = 0;
  let isFirstStart = true;
  let baseSpeed = 2;
  let speedMultiplier = 1;
  let gameStartTime = 0;

  // Configuración del juego
  const intenseBeatInterval = 3000;
  const normalBeatInterval = 800;
  const FALLING_KEY_HEIGHT = 30;
  const INTENSE_KEY_HEIGHT = 40;
  const GAME_AREA_TOP = 0;
  const SPEED_INCREASE_INTERVAL = 10000;
  const MAX_SPEED_MULTIPLIER = 3;

  // Cargar configuración y mejor puntuación
  function loadSettings() {
    const savedSettings = localStorage.getItem('pianoGameSettings');
    if (savedSettings) {
      const settings = JSON.parse(savedSettings);
      
      document.documentElement.style.setProperty('--bg-color', settings.bgColor);
      document.body.style.background = settings.bgColor;
      
      keys.forEach(key => {
        document.documentElement.style.setProperty(`--key-${key}-color`, settings.keyColors[key]);
        document.documentElement.style.setProperty(`--falling-${key}-color`, settings.fallingKeyColors[key]);
        document.getElementById(`key-${key}-color`).value = settings.keyColors[key];
        document.getElementById(`falling-${key}-color`).value = settings.fallingKeyColors[key];
      });
      
      document.getElementById('bg-color').value = settings.bgColor;
    }

    // Cargar mejor puntuación
    const savedHighScore = localStorage.getItem('pianoGameHighScore');
    if (savedHighScore) {
      highScore = parseInt(savedHighScore);
      highScoreDisplay.textContent = highScore;
    }
  }

  // Guardar mejor puntuación
  function saveHighScore() {
    if (score > highScore) {
      highScore = score;
      localStorage.setItem('pianoGameHighScore', highScore.toString());
      highScoreDisplay.textContent = highScore;
    }
  }

  // Resto del código (initializeSpotifyPlayer, transferPlayback, etc.) permanece igual...

  // Modificar la función exitGame para guardar la puntuación
  function exitGame() {
    if (!gameActive) return;
    
    gameActive = false;
    gamePaused = false;
    startBtn.disabled = false;
    pauseBtn.disabled = true;
    pauseBtn.textContent = 'Pausar';
    exitBtn.disabled = true;
    isFirstStart = true;
    speedMultiplier = 1;

    saveHighScore(); // Guardar la puntuación al salir

    if (animationId) cancelAnimationFrame(animationId);
    if (beatInterval) clearInterval(beatInterval);

    fallingKeys.forEach(k => {
      if (k.element.parentNode) k.element.parentNode.removeChild(k.element);
    });
    fallingKeys = [];

    keys.forEach(k => document.getElementById(`piano-key-${k}`).classList.remove('active'));
  }

  // Detectar cuando el usuario cambia de pestaña
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && gameActive && !gamePaused) {
      pauseGame();
    }
  });

  // Inicializar al cargar la página
  window.addEventListener('load', () => {
    loadSettings();
    
    document.querySelectorAll('input[type="color"]').forEach(input => {
      input.addEventListener('input', applySettings);
    });

    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');
    if (code) {
      exchangeCodeForToken(code);
      window.history.replaceState({}, document.title, redirectUri);
    }
  });

  // Resto del código JavaScript permanece igual...
</script>

</body>
</html>
